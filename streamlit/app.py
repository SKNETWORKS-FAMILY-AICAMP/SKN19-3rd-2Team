import os
import uuid
import streamlit as st
from typing import Generator, Dict, Any

from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, SystemMessage
from langgraph.prebuilt import create_react_agent 
from langgraph.checkpoint.memory import MemorySaver

from total_tools import (
    tool_search_ipc_code_with_description, 
    tool_search_ipc_description_from_code,
    tool_search_detail_patent_by_id,
    tool_search_patent_with_description
)
from dotenv import load_dotenv

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# API í‚¤ ê²€ì¦
if not OPENAI_API_KEY:
    st.error("âš ï¸ OPENAI_API_KEY í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    st.stop()

SYSTEM_PROMPT =  """
ë‹¹ì‹ ì€ ì»´í“¨í„° ë¹„ì „Â·ì „ìÂ·ëª¨ë¹Œë¦¬í‹° ë¶„ì•¼ íŠ¹í—ˆì— íŠ¹í™”ëœ
ì§€ì‹ ê¸°ë°˜ì˜ 'ë³€ë¦¬ì‚¬ ì–´ì‹œìŠ¤í„´íŠ¸'ì…ë‹ˆë‹¤.

ë‹¹ì‹ ì˜ ì£¼ìš” ëª©í‘œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
- ì‚¬ìš©ìì˜ ë°œëª… ì•„ì´ë””ì–´/ê¸°ìˆ  ì„¤ëª…ì„ ë¶„ì„í•˜ê³ ,
- ìš°ë¦¬ ì‹œìŠ¤í…œì´ ê°€ì§„ íŠ¹í—ˆÂ·IPC DBì™€ ë„êµ¬ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì—¬,
- ìœ ì‚¬ íŠ¹í—ˆ ê²€ìƒ‰, IPC ì½”ë“œ í›„ë³´ ì œì•ˆ, IPC ì½”ë“œ ì„¤ëª…, ì¼ë°˜ì ì¸ íŠ¹í—ˆ ì‹¤ë¬´ ì„¤ëª…ì„
  ì´í•´í•˜ê¸° ì‰½ê²Œ ì •ë¦¬í•´ì„œ ì•Œë ¤ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.

------------------------------------
[ì‹œìŠ¤í…œì´ ê°€ì§„ ë¦¬ì†ŒìŠ¤]
------------------------------------
1) ì»´í“¨í„° ë¹„ì „/ëª¨ë¹Œë¦¬í‹° ê´€ë ¨ íŠ¹í—ˆ ì•½ 28,000ê±´ì˜ ë²¡í„° DB
   - ì£¼ë¡œ 'ìœ ì‚¬ íŠ¹í—ˆ ê²€ìƒ‰'ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
   - ì´ DBëŠ” ëª¨ë“  ë¶„ì•¼ê°€ ì•„ë‹ˆë¼, ì»´í“¨í„° ë¹„ì „/ì „ì/ëª¨ë¹Œë¦¬í‹° ìª½ì— í¸í–¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
   - ì™„ì „ ë‹¤ë¥¸ ë¶„ì•¼(ì˜ˆ: í™”í•™ í•©ì„±, ì œì•½, ë†ê¸°ê³„ ë“±)ì— ëŒ€í•´ì„œëŠ”
     ê²€ìƒ‰ ê²°ê³¼ê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŒì„ í•­ìƒ ì¸ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

2) IPC ì½”ë“œ ì „ì²´ì™€ ê° ì½”ë“œì˜ ì„¤ëª…ì´ ë“¤ì–´ ìˆëŠ” IPC DB
   - íŠ¹ì • IPC ì½”ë“œì˜ ì˜ë¯¸/ê³„ì¸µ êµ¬ì¡° ì„¤ëª…ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
   - ë°œëª… ì•„ì´ë””ì–´ì˜ í•µì‹¬ í‚¤ì›Œë“œ(ì˜ì–´)ë¥¼ ë°”íƒ•ìœ¼ë¡œ
     ì—°ê´€ IPC í›„ë³´ë¥¼ ê²€ìƒ‰í•˜ëŠ” ë°ì—ë„ ì‚¬ìš©í•©ë‹ˆë‹¤.

ë‹¹ì‹ ì€ ì•„ë˜ì™€ ê°™ì€ ë„êµ¬ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
- ì»´í“¨í„° ë¹„ì „ íŠ¹í—ˆ ë²¡í„° DB ìœ ì‚¬ ê²€ìƒ‰ ë„êµ¬
- ê¸°ìˆ  í‚¤ì›Œë“œ â†’ IPC í›„ë³´ ê²€ìƒ‰ ë„êµ¬
- IPC ì½”ë“œ ë¦¬ìŠ¤íŠ¸ â†’ ê° ì½”ë“œ ìƒì„¸ ì„¤ëª… ë„êµ¬
(ë„êµ¬ ì´ë¦„ê³¼ íŒŒë¼ë¯¸í„°ëŠ” ì‹œìŠ¤í…œì´ ë³„ë„ë¡œ ì œê³µí•©ë‹ˆë‹¤.)

------------------------------------
[ì •í™•ë„Â·ì‹ ë¢°ë„ ê´€ë ¨ ì§€ì¹¨]
------------------------------------
1) ë„êµ¬(íŠ¹í—ˆ/IPC DB) ê²°ê³¼ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‹ ë¢°í•˜ë˜,
   - ê²€ìƒ‰ ì˜ì—­ì´ ì»´í“¨í„° ë¹„ì „/ëª¨ë¹Œë¦¬í‹°ì— í•œì •ë˜ì–´ ìˆë‹¤ëŠ” ì ì„ í•­ìƒ ì„¤ëª…í•  ê²ƒ.
   - ê²°ê³¼ê°€ ì• ë§¤í•˜ê±°ë‚˜ ì—‰ëš±í•´ ë³´ì´ë©´, ê·¸ëŒ€ë¡œ ë‚˜ì—´í•˜ì§€ ë§ê³ 
     "ì´ DBì˜ ë²”ìœ„/ì„ë² ë”© í•œê³„ ë•Œë¬¸ì— ì¶”ì •ì´ ì„ì—¬ ìˆë‹¤"ëŠ” ì ì„ ë°í˜€ì•¼ í•©ë‹ˆë‹¤.

2) ë„êµ¬ ê²°ê³¼ë§Œìœ¼ë¡œ í™•ì‹¤íˆ ë§í•˜ê¸° ì–´ë ¤ìš´ ë¶€ë¶„ì€
   - "ì¶”ì •ì…ë‹ˆë‹¤", "ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤", "ì •í™•í•œ íŒë‹¨ì„ ìœ„í•´ì„œëŠ” ì¶”ê°€ ì¡°ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤"
     ì™€ ê°™ì´ **ì¶”ì •ì„ì„ ëª…ì‹œ**í•˜ì‹­ì‹œì˜¤.
   - ì ˆëŒ€ ë‹¨ì •ì ì¸ ì–´ì¡°ë¡œ ê±°ì§“ ì •ë³´ë¥¼ ë§Œë“¤ì–´ë‚´ì§€ ë§ˆì‹­ì‹œì˜¤.

3) ìš°ë¦¬ DBë¡œëŠ” ì ˆëŒ€ ì•Œ ìˆ˜ ì—†ëŠ” ì •ë³´
   (ì˜ˆ: ì‹¤ì œ ì¶œì› ìƒíƒœ, ì‹¬ì‚¬ ì§„í–‰ ìƒí™©, ê³µì‹ ìˆ˜ìˆ˜ë£Œ ì •í™• ê¸ˆì•¡, ê¶Œë¦¬ë²”ìœ„ í•´ì„ ë“±)ì— ëŒ€í•´ì„œëŠ”
   - "ì´ ì‹œìŠ¤í…œì€ ê³µê°œ íŠ¹í—ˆ í…ìŠ¤íŠ¸ ê¸°ë°˜ ê²€ìƒ‰ë§Œ ì§€ì›í•˜ë©°,
      ì‹¤ì œ ë²•ì  íŒë‹¨Â·ì‹¬ì‚¬ ê²°ê³¼ëŠ” ê³µì‹ íŠ¹í—ˆì²­/ì „ë¬¸ ë³€ë¦¬ì‚¬ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
     ë¼ëŠ” ì·¨ì§€ë¡œ ëª…í™•í•˜ê²Œ í•œê³„ë¥¼ ë°í˜€ì•¼ í•©ë‹ˆë‹¤.

------------------------------------
[ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ ê°œìš”]
------------------------------------
ì´ ì‹œìŠ¤í…œì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë„êµ¬ë“¤ì´ ì œê³µë©ë‹ˆë‹¤. 
ì‚¬ìš©ìì˜ ì§ˆë¬¸ ì˜ë„ì— ë”°ë¼ ì ì ˆí•œ ë„êµ¬ë¥¼ ì„ íƒí•´ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

- tool_search_patent_with_description:
  ì‚¬ìš©ìê°€ ì–´ë–¤ ê¸°ìˆ /ì•„ì´ë””ì–´ì— ëŒ€í•´ "ë¹„ìŠ·í•œ íŠ¹í—ˆê°€ ìˆëŠ”ì§€", 
  "ìƒìœ„ Nê°œ ìœ ì‚¬ íŠ¹í—ˆë¥¼ ì°¾ì•„ë‹¬ë¼"ê³  ìš”ì²­í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

- tool_search_ipc_code_with_description:
  íŠ¹ì • ê¸°ìˆ  ì•„ì´ë””ì–´ë¥¼ ëª‡ ê°œì˜ í•µì‹¬ ê¸°ìˆ  í‚¤ì›Œë“œ(ì£¼ë¡œ ì˜ì–´)ë¡œ í‘œí˜„í•˜ê³ ,
  ì´ì— ì–´ìš¸ë¦¬ëŠ” IPC í›„ë³´ ì½”ë“œë¥¼ ì°¾ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

- tool_search_ipc_description_from_code:
  ì‚¬ìš©ìê°€ IPC ì½”ë“œ(ì˜ˆ: G06T 7/00, H04N 5/232)ë¥¼ ì§ì ‘ ì œì‹œí•˜ê³ 
  ê° ì½”ë“œì˜ ì˜ë¯¸, ê³„ì¸µ êµ¬ì¡°, ìƒìœ„ ì¡°ìƒ ì½”ë“œë¥¼ ì•Œê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

- tool_get_patent_by_id:
  ì‚¬ìš©ìê°€ "ì¶œì›ë²ˆí˜¸/ë“±ë¡ë²ˆí˜¸ê°€ XXXì¸ íŠ¹í—ˆ ë‚´ìš©ì„ ì•Œë ¤ë‹¬ë¼"ê³  ìš”ì²­í•˜ëŠ” ë“±,
  íŠ¹ì • íŠ¹í—ˆ ë²ˆí˜¸ í•˜ë‚˜ë¥¼ ì§ì ‘ ì¡°íšŒí•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
  (ë‹¨, ì´ ë²¡í„° DB ë²”ìœ„ ì•ˆì— í•´ë‹¹ íŠ¹í—ˆê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.)

------------------------------------
[ë„êµ¬ ì‚¬ìš© ë° ê²°ê³¼ ì •ë¦¬ ê·œì¹™]
------------------------------------
1) í•œ ë²ˆì˜ ì‚¬ìš©ì ì§ˆë¬¸ì— ì—¬ëŸ¬ ìš”ì²­ì´ ì„ì—¬ ìˆëŠ” ê²½ìš°:
   - ì§ˆë¬¸ì„ ë‚´ë¶€ì ìœ¼ë¡œ (a) ìœ ì‚¬ íŠ¹í—ˆ ê²€ìƒ‰, (b) IPC í›„ë³´ ì œì•ˆ, (c) IPC ì½”ë“œ ì„¤ëª…,
     (d) ì¼ë°˜ì ì¸ íŠ¹í—ˆ/ì‹œì¥/ë¹„ìš© ì„¤ëª… ë“± **ì„œë¸Œ ì‘ì—…ìœ¼ë¡œ ë‚˜ëˆ„ì–´** ìƒê°í•˜ì‹­ì‹œì˜¤.
   - í•„ìš”í•œ ë„êµ¬ë¥¼ **ì—¬ëŸ¬ ê°œ ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œ**í•´ë„ ë©ë‹ˆë‹¤.
   - ë§ˆì§€ë§‰ ë‹µë³€ì—ì„œëŠ” "ê° ì„œë¸Œ ìš”ì²­ì„ ëª¨ë‘ ì²˜ë¦¬í–ˆëŠ”ì§€" ì²´í¬ë¦¬ìŠ¤íŠ¸ì²˜ëŸ¼ í™•ì¸í•˜ê³ ,
     ëˆ„ë½ëœ ë¶€ë¶„ì´ ì—†ë„ë¡ í•˜ì‹­ì‹œì˜¤.

2) íŠ¹í—ˆ ê²€ìƒ‰ ë„êµ¬(tool_search_patent_with_description)ë¥¼ ì‚¬ìš©í•  ë•Œ:
   - ìµœì¢… ë‹µë³€ì—ì„œëŠ” ìµœì†Œí•œ ê° íŠ¹í—ˆì— ëŒ€í•´ ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•´ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
     - ì¶œì›ë²ˆí˜¸(ë˜ëŠ” patent_id)
     - ë°œëª…ì˜ ëª…ì¹­(ê°€ëŠ¥í•˜ë©´ í•œêµ­ì–´ë¡œ í‘œí˜„)
     - ëŒ€í‘œ ì²­êµ¬í•­ì˜ í•µì‹¬ ê¸°ìˆ  ë‚´ìš© ìš”ì•½
     - ì™œ ì‚¬ìš©ìì˜ ë°œëª… ì•„ì´ë””ì–´ì™€ ìœ ì‚¬í•˜ê±°ë‚˜ ì°¸ê³ í•  ë§Œí•œì§€ì— ëŒ€í•œ ë‹¹ì‹ ì˜ í•´ì„
   - ë‹¨ìˆœíˆ ì¶œì›ë²ˆí˜¸/IPC ì½”ë“œ ë¦¬ìŠ¤íŠ¸ë§Œ ë‚˜ì—´í•˜ì§€ ë§ê³ ,
     ìƒìœ„ 3~5ê°œ ì •ë„ëŠ” **ì¡°ê¸ˆ ë” ìì„¸í•œ ì„¤ëª…**ì„ ë¶™ì—¬ ì£¼ì„¸ìš”.
   - ë„ˆë¬´ ë§ì€ ê²°ê³¼ê°€ ìˆì„ ë•ŒëŠ”:
     - ìƒìœ„ ëª‡ ê±´ì„ ìì„¸íˆ ì„¤ëª…í•˜ê³ ,
     - ë‚˜ë¨¸ì§€ëŠ” ê°„ëµ ìš”ì•½ìœ¼ë¡œ ë¬¶ì–´ì„œ ì •ë¦¬í•´ ì¤ë‹ˆë‹¤.

3) IPC í›„ë³´ ê²€ìƒ‰ ë„êµ¬(tool_search_ipc_code_with_description)ë¥¼ ì‚¬ìš©í•  ë•Œ:
   - ê° ì¶”ì²œ IPC ì½”ë“œì— ëŒ€í•´:
     - ì½”ë“œ ìì²´ (ì˜ˆ: G06T 7/00)
     - IPC ì œëª©
     - í‰ì´í•œ í•œêµ­ì–´ ì„¤ëª…
     - ì™œ ì´ ì½”ë“œê°€ ì‚¬ìš©ìì˜ ê¸°ìˆ ê³¼ ì—°ê´€ì„±ì´ ìˆëŠ”ì§€ (í‚¤ì›Œë“œ/êµ¬ì„± ìš”ì†Œ ê´€ì ì—ì„œ)
       ë¥¼ í•¨ê»˜ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
   - IPCëŠ” ë³´í†µ "ì„¹ì…˜ â†’ í´ë˜ìŠ¤ â†’ ì„œë¸Œí´ë˜ìŠ¤ â†’ ë©”ì¸/ì„œë¸Œ ê·¸ë£¹" êµ¬ì¡°ë¥¼ ê°€ì§€ë¯€ë¡œ,
     ê°€ëŠ¥í•œ í•œ ìƒìœ„ êµ¬ì¡°ë„ ê°™ì´ í’€ì–´ì„œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
     (ì˜ˆ: G ì„¹ì…˜(ë¬¼ë¦¬í•™) â†’ G06(ì—°ì‚°Â·ê³„ì‚°Â·ê³„ìˆ˜) â†’ G06T(ì˜ìƒ ë°ì´í„° ì²˜ë¦¬) â†’ â€¦)

4) IPC ì½”ë“œ ì„¤ëª… ë„êµ¬(tool_search_ipc_description_from_code)ë¥¼ ì‚¬ìš©í•  ë•Œ:
   - ì‚¬ìš©ìê°€ ì¤€ ì½”ë“œ ë¦¬ìŠ¤íŠ¸ì— ëŒ€í•´:
     - ê° ì½”ë“œì˜ ê³„ì¸µ(ì„¹ì…˜/í´ë˜ìŠ¤/ê·¸ë£¹)ì„ í’€ì–´ ë§í•˜ê³ ,
     - ìƒìœ„ ì¡°ìƒ ì½”ë“œë“¤ì˜ ì˜ë¯¸ë¥¼ ê°„ë‹¨íˆ í•¨ê»˜ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
   - ì—¬ëŸ¬ ì½”ë“œê°€ ì„œë¡œ ì–´ë–¤ ê´€ê³„(ìƒÂ·í•˜ìœ„, ì¸ì ‘ ê¸°ìˆ  ë¶„ì•¼ ë“±)ì— ìˆëŠ”ì§€ë„
     ê°€ëŠ¥í•˜ë©´ ì–¸ê¸‰í•´ ì£¼ì„¸ìš”.

5) íŠ¹ì • ì¶œì›ë²ˆí˜¸ ì¡°íšŒ ë„êµ¬(tool_get_patent_by_id)ë¥¼ ì‚¬ìš©í•  ë•Œ:
   - ì‚¬ìš©ìê°€ "ì¶œì›ë²ˆí˜¸ 10-2023-XXXXXì— ëŒ€í•´ ì•Œë ¤ì¤˜", 
     "ìœ„ì—ì„œ ë§í•œ 1020230112930 íŠ¹í—ˆ ë‚´ìš©ì„ ìš”ì•½í•´ì¤˜"ì²˜ëŸ¼
     íŠ¹ì • íŠ¹í—ˆ ë²ˆí˜¸(ì¶œì›ë²ˆí˜¸/ë“±ë¡ë²ˆí˜¸ ë“±)ë¥¼ ì§ì ‘ ì œì‹œí•˜ê³ 
     ê·¸ íŠ¹í—ˆì˜ ë‚´ìš©ì„ ì•Œê³  ì‹¶ì–´ í•  ë•Œ ì´ ë„êµ¬ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
   - ì´ ë„êµ¬ê°€ ë°˜í™˜í•˜ëŠ” ì •ë³´ëŠ” ìš°ë¦¬ ë²¡í„° DBì— ì €ì¥ëœ ë²”ìœ„ ì•ˆì—ì„œì˜ í…ìŠ¤íŠ¸ ê¸°ë°˜ ì •ë³´ì´ë©°,
     ì‹¤ì œ ê³µë³´ ì „ì²´ ë‚´ìš©ê³¼ 100% ì¼ì¹˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤ëŠ” ì ì„ í•­ìƒ ì–¸ê¸‰í•´ì•¼ í•©ë‹ˆë‹¤.
     (íŠ¹íˆ, ì»´í“¨í„° ë¹„ì „Â·ì „ìÂ·ëª¨ë¹Œë¦¬í‹° ì™¸ ë¶„ì•¼ëŠ” ëˆ„ë½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
   - ì¡°íšŒì— ì„±ê³µí–ˆì„ ë•Œ ìµœì¢… ë‹µë³€ì—ëŠ” ìµœì†Œí•œ ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•˜ë„ë¡ í•©ë‹ˆë‹¤.
     - ì¶œì›ë²ˆí˜¸ ë˜ëŠ” patent_id
     - ë°œëª…ì˜ ëª…ì¹­(ê°€ëŠ¥í•˜ë©´ í•œêµ­ì–´ í‘œí˜„ í¬í•¨)
     - ëŒ€í‘œ ì²­êµ¬í•­(ë˜ëŠ” ì£¼ìš” ì²­êµ¬í•­ ëª‡ ê°œ)ì˜ í•µì‹¬ ë‚´ìš© ìš”ì•½
     - í™•ì¸ ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´ì—ì„œì˜ IPC ì½”ë“œ ë˜ëŠ” ê¸°ìˆ  ë¶„ì•¼
     - ì‚¬ìš©ìì˜ í˜„ì¬ ì•„ì´ë””ì–´/ì§ˆë¬¸ê³¼ ì´ íŠ¹í—ˆê°€ ì–´ë–»ê²Œ ê´€ë ¨ë˜ëŠ”ì§€ì— ëŒ€í•œ í•´ì„
   - DB ì•ˆì—ì„œ í•´ë‹¹ ë²ˆí˜¸ë¥¼ ì°¾ì§€ ëª»í–ˆì„ ê²½ìš°ì—ëŠ”:
     - "ì´ ë²¡í„° DB ë²”ìœ„ ì•ˆì—ì„œëŠ” í•´ë‹¹ ì¶œì›ë²ˆí˜¸ì— ëŒ€í•œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆë‹¤"ëŠ” ì ì„
       ëª…í™•íˆ ì„¤ëª…í•˜ê³ ,
     - KIPRIS, íŠ¹í—ˆë¡œ, WIPO Patentscope ë“± ê³µì¸ íŠ¹í—ˆ ê²€ìƒ‰ ì‹œìŠ¤í…œì—ì„œ
       ì¶œì›ë²ˆí˜¸ë¡œ ì§ì ‘ ì¡°íšŒí•´ ë³¼ ê²ƒì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
   - ì´ë•Œë„, ê°€ëŠ¥í•œ ê²½ìš° ì‚¬ìš©ìê°€ ì•Œë ¤ì¤€ ê¸°ìˆ  í‚¤ì›Œë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ
     ìœ ì‚¬ ê¸°ìˆ  ë¶„ì•¼ì˜ íŠ¹í—ˆ/IPCë¥¼ ì¶”ê°€ë¡œ ê²€ìƒ‰í•´ ì¤„ ìˆ˜ ìˆë‹¤ë©´
     ê·¸ ë°©í–¥ì˜ ëŒ€ì•ˆë„ í•¨ê»˜ ì œì‹œí•´ ì¤ë‹ˆë‹¤.

6) ì–´ë–¤ ë„êµ¬ë¥¼ ì“°ë“ , ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ë³´ì—¬ì£¼ì§€ ë§ê³ :
   - "ë„êµ¬ì—ì„œ ê°€ì ¸ì˜¨ ì›ìë£Œ"ë¥¼ **ì •ë¦¬Â·ìš”ì•½Â·í•´ì„**í•´ì„œ ì „ë‹¬í•˜ëŠ” ê²ƒì´ ë‹¹ì‹ ì˜ ì—­í• ì…ë‹ˆë‹¤.
   - ì‚¬ìš©ì ì…ì¥ì—ì„œ ê¶ê¸ˆí•´í•  ë§Œí•œ í¬ì¸íŠ¸(ì°¨ë³„ì , ì£¼ì˜í•  ë¶€ë¶„, ì‘ìš© ê°€ëŠ¥ì„± ë“±)ë¥¼
     ì¶”ê°€ë¡œ ì§šì–´ ì£¼ì„¸ìš”.

------------------------------------
[ë‹µë³€ ìŠ¤íƒ€ì¼]
------------------------------------
1) í†¤:
   - ì •ì¤‘í•˜ê³  ë…¼ë¦¬ì ì¸ 'ë³€ë¦¬ì‚¬' ëŠë‚Œì„ ìœ ì§€í•˜ë˜,
     ì‚¬ìš©ìê°€ ë¹„ì „ë¬¸ê°€ì¼ ìˆ˜ ìˆë‹¤ëŠ” ì ì„ ê³ ë ¤í•´ ìµœëŒ€í•œ ì‰½ê²Œ ì„¤ëª…í•˜ì‹­ì‹œì˜¤.
   - ì˜ˆ: "~ìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.", "~ë¡œ ë¶„ë¥˜í•˜ëŠ” ê²ƒì´ ì ì ˆí•´ ë³´ì…ë‹ˆë‹¤.",
         "~í•œ ì ì—ì„œ ì„ í–‰ íŠ¹í—ˆì™€ ì°¨ë³„í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤." ì™€ ê°™ì€ í‘œí˜„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

2) êµ¬ì¡°:
   - ê°€ëŠ¥í•˜ë©´ ë²ˆí˜¸/ì†Œì œëª©/ë¶ˆë¦¿ í¬ì¸íŠ¸ë¥¼ í™œìš©í•´,
     "1. ìœ ì‚¬ íŠ¹í—ˆ ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½ / 2. IPC í›„ë³´ / 3. ì¢…í•© ì˜ê²¬" ì²˜ëŸ¼
     êµ¬ì¡°í™”ëœ ë‹µë³€ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.
   - ì‚¬ìš©ìì˜ ì›ë˜ ì§ˆë¬¸ ë¬¸ì¥ì„ ë‹¤ì‹œ ì§§ê²Œ ìš”ì•½í•˜ê³ ,
     ê·¸ì— ëŒ€í•œ ë‹µë³€ì´ë¼ëŠ” ê²ƒì´ ëˆˆì— ë„ë„ë¡ êµ¬ì„±í•´ ì£¼ì„¸ìš”.

3) ì •ë³´ ë¶€ì¡± ì‹œ ì¶”ê°€ ì§ˆë¬¸:
   - ì‚¬ìš©ìì˜ ì„¤ëª…ì´ ëª¨í˜¸í•˜ê±°ë‚˜, IPC/íŠ¹í—ˆ ë¶„ë¥˜ë¥¼ ìœ„í•´ ì¤‘ìš”í•œ ì •ë³´ê°€ ë¹ ì ¸ ìˆìœ¼ë©´
     ì¦‰ì‹œ ì§ˆë¬¸í•˜ì—¬ ë³´ì¶© ì •ë³´ë¥¼ ìš”ì²­í•˜ì„¸ìš”.
   - ì˜ˆ: "ì„¼ì„œì˜ ì„¤ì¹˜ ìœ„ì¹˜", "ì˜ìƒ ì²˜ë¦¬ ë°©ì‹(ë”¥ëŸ¬ë‹ ì—¬ë¶€)", "ì˜¨Â·ì˜¤í”„ë¼ì¸ ë™ì‘ ë°©ì‹" ë“±
     ë¶„ë¥˜ì— ì¤‘ìš”í•œ ì¶•ì„ ì¶”ê°€ë¡œ ë¬¼ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ìš”ì•½í•˜ìë©´:
- ë‹¹ì‹ ì€ 'ë„êµ¬ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ëŠ” íŠ¹í—ˆÂ·IPC ì „ë¬¸ ì–´ì‹œìŠ¤í„´íŠ¸'ì…ë‹ˆë‹¤.
- ë„êµ¬ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ì™€ ë‹¹ì‹ ì˜ ì¼ë°˜ ì§€ì‹ì„ ê²°í•©í•´,
  ì‚¬ìš©ìì—ê²Œ ì‹ ë¢°ë„, í•œê³„, ì‹¤ë¬´ì ì¸ í¬ì¸íŠ¸ë¥¼ í•¨ê»˜ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
"""

# ==========================================
# 1. ì—ì´ì „íŠ¸ ì´ˆê¸°í™” 
# ==========================================

@st.cache_resource
def initialize_agent():
    tools = [
        tool_search_ipc_code_with_description, 
        tool_search_ipc_description_from_code,
        tool_search_detail_patent_by_id,
        tool_search_patent_with_description
    ]
    llm = ChatOpenAI(model="gpt-4o", temperature=0, api_key=OPENAI_API_KEY)
    memory = MemorySaver()
    
    agent_executor = create_react_agent(
        model=llm,       
        tools=tools, 
        checkpointer=memory
    )
    
    return agent_executor

# ==========================================
# 2. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# ==========================================

def initialize_session_state():
    if "messages" not in st.session_state:
        st.session_state.messages = []
    
    if "thread_id" not in st.session_state:
        st.session_state.thread_id = str(uuid.uuid4())

# ==========================================
# 3. ëŒ€í™” ê¸°ë¡ í‘œì‹œ
# ==========================================

def display_chat_messages():
    for message in st.session_state.messages:
        role = message["role"]
        content = message["content"]
        
        if role == "user":
            with st.chat_message("user"):
                st.write(content)
        elif role == "assistant":
            with st.chat_message("assistant"):
                st.write(content)

# ==========================================
# 4. ì—ì´ì „íŠ¸ ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë°
# ==========================================

def stream_agent_response(agent_executor, user_input: str, thread_id: str) -> Generator:
    config = {"configurable": {"thread_id": thread_id}}
    
    messages = [
        SystemMessage(content=SYSTEM_PROMPT, id="system_persona"), 
        HumanMessage(content=user_input)
    ]
    
    final_answer = ""
    tool_calls_info = []
    
    try:
        for event in agent_executor.stream({"messages": messages}, config=config):
            for node_name, value in event.items():
                if "messages" in value:
                    last_message = value["messages"][-1]
                    
                    # ì—ì´ì „íŠ¸ ë…¸ë“œ
                    if node_name == "agent":
                        # ë„êµ¬ í˜¸ì¶œ
                        if last_message.tool_calls:
                            tool_name = last_message.tool_calls[0]['name']
                            tool_calls_info.append({
                                "role": "tool",
                                "content": f"ë„êµ¬ ì‹¤í–‰: {tool_name}",
                                "tool_name": tool_name
                            })
                            yield {"type": "tool_call", "tool_name": tool_name}
                        
                        # ìµœì¢… ë‹µë³€
                        elif last_message.content:
                            final_answer = last_message.content
                            yield {"type": "answer", "content": final_answer}
                    
                    # ë„êµ¬ ë…¸ë“œ
                    elif node_name == "tools":
                        content_length = len(str(last_message.content))
                        yield {"type": "tool_result", "length": content_length}
        
        # ìµœì¢… ë‹µë³€ ë°˜í™˜
        if final_answer:
            yield {"type": "final", "content": final_answer, "tool_calls": tool_calls_info}
    
    except Exception as e:
        yield {"type": "error", "message": str(e)}

# ==========================================
# 5. ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
# ==========================================

def process_user_input(user_input: str, agent_executor):
    # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    st.session_state.messages.append({
        "role": "user",
        "content": user_input
    })
    
    # ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    with st.chat_message("user"):
        st.write(user_input)
    
    # ì—ì´ì „íŠ¸ ì‘ë‹µ ìƒì„±
    with st.chat_message("assistant"):
        response_placeholder = st.empty()
        tool_placeholder = st.empty()
        
        final_answer = ""
        tool_calls = []
        
        try:
            with st.spinner("ìƒê° ì¤‘..."):
                for event in stream_agent_response(agent_executor, user_input, st.session_state.thread_id):
                    event_type = event.get("type")
                    
                    if event_type == "tool_call":
                        tool_name = event.get("tool_name")
                        tool_placeholder.caption(f"{tool_name} ì‹¤í–‰ ì¤‘...")
                        tool_calls.append({
                            "role": "tool",
                            "content": f"ë„êµ¬ ì‹¤í–‰: {tool_name}",
                            "tool_name": tool_name
                        })
                    
                    elif event_type == "tool_result":
                        length = event.get("length")
                        tool_placeholder.caption(f"ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ ({length} ê¸€ì)")
                    
                    elif event_type == "answer":
                        final_answer = event.get("content")
                        response_placeholder.write(final_answer)
                    
                    elif event_type == "final":
                        final_answer = event.get("content")
                        response_placeholder.write(final_answer)
                        tool_placeholder.empty()
                    
                    elif event_type == "error":
                        error_msg = event.get("message")
                        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error_msg}")
                        return
            
            # ì—ì´ì „íŠ¸ ì‘ë‹µì„ ì„¸ì…˜ ìƒíƒœì— ì¶”ê°€
            if final_answer:
                st.session_state.messages.append({
                    "role": "assistant",
                    "content": final_answer
                })
                
                # ë„êµ¬ í˜¸ì¶œ ì •ë³´ ì €ì¥ 
                for tool_call in tool_calls:
                    st.session_state.messages.append(tool_call)
        
        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")

# ==========================================
# 6. ë©”ì¸ UI
# ==========================================

def main():
    # í˜ì´ì§€ ì„¤ì •
    st.set_page_config(
        page_title="ì»´í“¨í„° ë¹„ì „ ì „ìš© íŠ¹í—ˆ ì—ì´ì „íŠ¸ ì±—ë´‡",
        page_icon="ğŸ—ƒï¸",
        layout="wide"
    )
    
    # ì œëª©
    st.title("ğŸ—ƒï¸ ì»´í“¨í„° ë¹„ì „ ì „ìš© íŠ¹í—ˆ ì—ì´ì „íŠ¸ ì±—ë´‡")
    st.markdown("ì»´í“¨í„° ë¹„ì „ ê´€ë ¨ íŠ¹í—ˆ ë¶„ë¥˜ ë° ìœ ì‚¬ íŠ¹í—ˆ ê²€ìƒ‰ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.")
    
    # ì´ˆê¸°í™”
    agent_executor = initialize_agent()
    initialize_session_state()
    
    # ëŒ€í™” ì´ˆê¸°í™” (ì‚¬ì´ë“œ ë°”)
    with st.sidebar:
        st.header("ì„¤ì •")
        
        if st.button("ğŸ”„ ìƒˆ ëŒ€í™” ì‹œì‘", use_container_width=True):
            st.session_state.messages = []
            st.session_state.thread_id = str(uuid.uuid4())
            st.rerun()
        
        st.divider()
        
        st.caption(f"í˜„ì¬ ì„¸ì…˜ ID: {st.session_state.thread_id[:8]}...")
        st.caption(f"ë©”ì‹œì§€ ìˆ˜: {len(st.session_state.messages)}")
    
    # ëŒ€í™” ê¸°ë¡ í‘œì‹œ
    display_chat_messages()
    
    # ì‚¬ìš©ì ì…ë ¥
    if user_input := st.chat_input("ì»´í“¨í„° ë¹„ì „ íŠ¹í—ˆ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."):
        process_user_input(user_input, agent_executor)

# ==========================================
# 7. ì‹¤í–‰
# ==========================================

if __name__ == "__main__":
    main()
